<!doctype html>
<html>
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
    <meta charset="utf-8" />
    <meta name="keywords" content="Rudy Jahchan" />
    <meta name="author" content="Rudy Jahchan" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="og:type" content="article">
<meta name="og:url" content="http://rudyjahchan.com/2013/02/20/monkey-patching-ios-with-objective-c-categories-part-iii-swizzling/">
    <meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Monkey-Patching iOS with Objective-C Categories Part III: Swizzling">
<meta name="og:title" content="Monkey-Patching iOS with Objective-C Categories Part III: Swizzling">
<meta name="twitter:site" content="@rudy">
<meta name="twitter:creator" content="@rudy">
<meta name="twitter:description" content="Originally posted on Carbon Five&#x27;s Blog.

Have you ever wanted to introduce new functionality to base classes in the iOS SDK?
Or just make them work a little differently? In order to do so, you must...">
<meta name="og:description" content="Originally posted on Carbon Five&#x27;s Blog.

Have you ever wanted to introduce new functionality to base classes in the iOS SDK?
Or just make them work a little differently? In order to do so, you must...">

    <title>Monkey-Patching iOS with Objective-C Categories Part III: Swizzling - Rudy Jahchan</title>
    <link href="http://feeds.feedburner.com/rudyjahchan" rel="alternate" title="Rudy Jahchan" type="application/rss+xml" />
    <link href="/stylesheets/all.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/8d26a9e428.js"></script>
  </head>
  <body>
    <header id="main" class="navbar">
      <div class="navbar__brand"><a href="/">Rudy Jahchan&nbsp;<span>&nbsp;</span></a></div>
      <nav id="main" class="site-nav">
        <ul class="links menu-activable">
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/about/">About</a></li>
        </ul>
        <button id="menu-toggle" class="menu-activable">
          <span class="sr-only">Toggle navigation</span>
          <i class="fa fa-bars" aria-hidden="true"></i>
        </button>
      </nav>
    </header>
    <div id="faux-terminal">
      <div class="layer"></div>
      <div class="overlay"></div>
    </div>
    <div class="content">  <article>
      <header class="article-content">
	<h1><a href="/2013/02/20/monkey-patching-ios-with-objective-c-categories-part-iii-swizzling/">Monkey-Patching iOS with Objective-C Categories Part III: Swizzling</a></h1>
		<time datetime="2013-02-20 00:00">Published on Feb 20, 2013</time>
</header>

    <div class="article-content">  <p><em>Originally posted on <a href="http://blog.carbonfive.com/2013/02/20/monkey-patching-ios-with-objective-c-categories-part-iii-swizzling/">Carbon Five's Blog</a>.</em></p>

<p>Have you ever wanted to introduce new functionality to base classes in the iOS SDK?
Or just make them work a <strong>little</strong> differently? In order to do so, you must enter the wild and dangerous world of monkey-patching.</p>

<p>In this series of posts, we'll show how to monkey-patch in Objective-C through <a href="http://developer.apple.com/library/ios/#documentation/cocoa/conceptual/objectivec/chapters/occategories.html">categories</a> to <a href="http://blog.carbonfive.com/2012/01/23/monkey-patching-ios-with-objective-c-categories-part-1-simple-extensions-and-overrides/">add and change methods</a>, to add new instance variables and properties, and introduce swizzling, a technique that allows us to extend and preserve existing functionality. <a href="#tldr"><strong>TL;DR »</strong></a></p>

<p>In the <a href="http://blog.carbonfive.com/2012/01/23/monkey-patching-ios-with-objective-c-categories-part-1-simple-extensions-and-overrides/">first post</a> we showed how you can add or override methods with extensions. The <a href="http://blog.carbonfive.com/2012/11/27/monkey-patching-ios-with-objective-c-categories-part-ii-adding-instance-properties/">second post</a> focused on getting around restrictions on creating instance variables when adding properties to the classes being modified. This third and final post covers the technique of swizzling to override existing methods while preserving their behaviour.</p>

<h2 id="the-problem-with-simply-overriding">The Problem with Simply Overriding</h2>

<p>Back in the original post of this series we discussed that while categories certainly allowed us to bluntly override existing methods of any class in the iOS SDK this was <em>strongly</em> discouraged for two reasons:</p>

<ol>
  <li>Other frameworks, both in the SDK or third-party, rely on the expected behavior of the original method. We would either have to re-implement that behavior in addition to the new functionality we wanted to introduce, or suffer side effects or more major errors due to its abscence.</li>
  <li>If multiple categories override the same method only the last one loaded wins out as load order is non-deterministic; its possible even the original method will remain unaffected.</li>
</ol>

<p>Ideally we need a way to have the new method handle calls to the original mathod, but preserve the original method so as to be able to invoke it when needed, much like the Ruby on Rails' <a href="http://api.rubyonrails.org/classes/Module.html#method-i-alias_method_chain"><code>alias_method_chain</code></a>. Which is exactly what the <strong>swizzling</strong> technique provides.</p>

<h2 id="the-solution-swizzling">The Solution: Swizzling</h2>

<p>So far I've been incorrectly referring to the "methods" of a class. But in Objective-C, when you write the following:</p>

<pre><code>[self presentViewController:mailController animated:YES completion:nil];
</code></pre>

<p>you are not actually invoking the <code>presentViewController:animated:completion:</code> <em>method</em> but are instead <em>sending</em> a <code>presentViewController:animated:completion:</code> <em>message</em>! How an object handles that message is determined at run-time by looking for a method under the message identifier or as it is commonly known as the selector. Normally this is the signature the method was declared under but it <em>can</em> be changed at run-time!</p>

<p>Swizzling is simply exchanging the implementation of two of a class' methods so that when a message is sent using the original selector of one it actually goes to the other. In general, whether for monkey-patching or other scenarios, this is accomplished by using a number of Objective-C Runtime functions:</p>

<script src="https://gist.github.com/rudyjahchan/2191796.js?file=SwizzleExample.m"></script>

<p>Walking through the above code:</p>

<ol>
  <li>First we build selectors (the <code>SEL</code> variables) to identify the methods we are swizzling; in this case <code>firstMethod</code> and <code>secondMethod</code>.</li>
  <li>References to the methods the selectors point to (represented by the <code>Method</code> data type) are then retrieved.</li>
  <li>We first attempt to add the implementation of the second method under the selector of the first method. We do this in case the first method doesn't truly exist, which is sometimes a possibility.</li>
  <li>If the method was added successfully we need SOMETHING under the selector of the second method, so we simply replace it with the first method's (empty) implementation.</li>
  <li>If we failed to add the method, the first method already exists, so we can simply exchange their implementations.</li>
</ol>

<p>Now, for the purposes of "monkey-patching", we rarely want to exchange two <em>existing</em> methods. Instead we introduce a new method and then swizzle it with the original. Any calls to the original method will now be directed to the new implementation while the original implementation can be invoked under the name of the new method!</p>

<p>Let's look at…</p>

<h2 id="an-example">An Example</h2>

<p>Going back to the last post's scenario of extending <code>UIViewController</code> with tour-guide functionality, suppose we want the tour guide information is to appear the first time a view is displayed to a user. The ideal place to have this happen is as part of the <code>viewWillAppear:</code> call all controllers receive. Remember, we <em>could</em> spend time adding a sub-class for every controller variation we will use, but that could lead to unnecessary code bloat. But since <code>viewWillAppear:</code> is critical to the UI life-cycle, we can't simply replace it. Hence, we need to swizzle it!</p>

<p>As a best practice when we swizzle a method, it's with a method with the <em>same signature</em> and a <em>similar but unique</em> name. In our case, we'll be creating <code>tourGuideWillAppear</code>:</p>

<script src="https://gist.github.com/rudyjahchan/2191796.js?file=UIViewController_TourGuide_Override.m">
</script>

<p>Note the call to <code>tourGuideWillAppear</code> within its own implementation. You may be asking yourself "Isn't that going to result in an infinite recursive loop?"</p>

<p>But at what you have to remember is that at the point the method is invoked the swizzling will have already taken place. That seemingly recursive call will actually go to the original <code>viewWillAppear:</code>. So remember, <em>to invoke the original method implmentation, call it with the new method's name</em>.</p>

<h2 id="swizzle-on-load">Swizzle on Load</h2>

<p>Of course, we still have to at some point perform the swizzle. The first instinct would be to toss it into the <code>init</code> method of a class, but this is incorrect because:</p>

<ol>
  <li>We are not creating a class, but a category that will be mixed into a class whose <code>init</code> you probably don't want to override and</li>
  <li>Even if that was possible, it's something you only want to do <em>once</em> per <em>class</em>, and not in the per <em>instance</em> constructor!</li>
</ol>

<p>Luckily, when the Objective-C Runtime loads a category, it invokes a class-level <code>load</code> method. This is the perfect opportunity to perform the swizzle. We also wrap it with a <code>dispatch_once</code> block call to ensure it only happens the one time:</p>

<script src="https://gist.github.com/rudyjahchan/2191796.js?file=SwizzleUIVIewController.m"></script>

<p>And with that our swizzle is complete; when the framework calls <code>viewWillAppear:</code> on any controller it will pass through our <code>tourGuideWillAppear:</code>, triggering our custom tour-guide functionality. We can apply this same technique to extend any class method whether called by the framework or us directly, injecting new behavior while preserving any critical functionality.</p>

<p>We have achieved true monkey-patching!</p>

<h2 id="drying-it-up">DRYing it Up</h2>

<p>Our example has us replacing one method in one class but already it makes for a lot of code. Imagine having to repeat that multiple times across many categories. Let us DRY it up by introducing, in an elegantly meta way, a swizzling <em>category</em> on the base <code>NSObject</code>:</p>

<script src="https://gist.github.com/rudyjahchan/2191796.js?file=NSObject_Swizzle.h"></script>

<script src="https://gist.github.com/rudyjahchan/2191796.js?file=NSObject_Swizzle.m"></script>

<p>Now in the <code>+load</code> of any category we simply call <code>swizzleInstanceSelector</code> on the category it<code>self</code> with the selectors of the methods we are swizzling. Here's the final <code>UIViewController+TourGuide</code> category implementation to illustrate that and all the other monkey-patching techniques we have learned in this series:</p>

<script src="https://gist.github.com/rudyjahchan/2191796.js?file=UIViewController_TourGuide.m"></script>

<h2 id="a-nametldra-tldr"><a name="tldr"></a> TL;DR</h2>

<ul>
  <li>Use swizzling to preserve the original method behavior instead of simply overriding to avoid side-effects.</li>
  <li>Swizzling is simply the exchange of the identifiers of two methods so they point to each other's implementations.</li>
  <li>After swizzling you invoke the original method's implementation but calling the new implementations identifier.</li>
  <li>Swizzle in the <code>+load</code> method of your category.</li>
</ul>


  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR
       WEBPAGE * * */
  var disqus_shortname = 'rudyjahchan';
  var disqus_url = 'http://rudyjahchan.com/2013/02/20/monkey-patching-ios-with-objective-c-categories-part-iii-swizzling/';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
   var dsq = document.createElement('script');
   dsq.type = 'text/javascript'; dsq.async =
   true;
   dsq.src = 'http://' +
   disqus_shortname +
   '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0]
    ||
    document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();

(function () {
 var s = document.createElement('script'); s.async = true;
 s.type = 'text/javascript';
 s.src = 'http://' + disqus_shortname +
 '.disqus.com/count.js';
 (document.getElementsByTagName('HEAD')[0]
  ||
  document.getElementsByTagName('BODY')[0]).appendChild(s);
 }());

</script>
<noscript>Please enable
  JavaScript to view the
  <a
    href="http://disqus.com/?ref_noscript">comments
    powered by
    Disqus.</a></noscript>
<a
  href="http://disqus.com"
  class="dsq-brlink">blog
  comments powered by
  <span
    class="logo-disqus">Disqus</span></a>
</div>
  </article>
</div>
    <footer>
      <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>&nbsp;
      <nav class="social">
        <a href="http://twitter.com/rudy"><i class="fa fa-twitter"></i></a>&nbsp;
        <a href="http://github.com/rudyjahchan/"><i class="fa fa-github"></i></a>&nbsp;
        <a href="http://instagram.com/rudyjahchan"><i class="fa fa-instagram"></i></a>&nbsp;
        <a href="http://feeds.feedburner.com/rudyjahchan"><i class="fa fa-rss"></i></a>
      </nav>
    </footer>
    <script src="/javascripts/all.js"></script>
  </body>
</html>
